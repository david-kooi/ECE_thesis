clear all;
close all;

initialization_common();

%% Run Corollary 2
% Tunable parameters
Ts_star = 0.25; % Determined through minT_calc_corr2.m
T_min   = Ts_star; 
T_max   = 2;
r       = 0.025;
N       = 10;
cs      = 1;
ch      = 0.5;
method  = 1; % 0: Scaled TBar
             % 1: 2-Step horizon TBar
         
% Uncomment to calculate T_s^*.
%minT_calc_corr2(0, T_min, T_max, r, N, cs, ch, method);
            
[t_corr2, j_corr2, x_corr2] = ...
    run_corr2_sim(Ts_star, T_min, T_max, r, N, cs, ch, method);

x1_corr2 = x_corr2(:,2);
x2_corr2 = x_corr2(:,3);
u_corr2  = x_corr2(:,4);
V_corr2  = get_V(x1_corr2, x2_corr2);

%Ts_corr2 = x_corr2(:,6);
global Ts_corr2;
Ts_avg_corr2 = mean(Ts_corr2);

%% Run Event-Triggered Baseline
% Tunable parameters
epsilon = 0.9; % Margin before control update

[t_ev, j_ev, x_ev] = run_ev_sim(epsilon);

x1_ev = x_ev(:,2);
x2_ev = x_ev(:,3);
u_ev  = x_ev(:,4);
V_ev  = get_V(x1_ev, x2_ev);

%Ts_ev = x_ev(:,6);

global Ts_ev;
Ts_avg_ev = mean(Ts_ev);

%% Run Di benedetto
% Tunable parameters
v = 0.85;
[t_diben, j_diben, x_diben] = run_diben_sim(v);

x1_diben = x_diben(:,2);
x2_diben = x_diben(:,3);
u_diben  = x_diben(:,4);
V_diben  = get_V(x1_diben, x2_diben);

%Ts_diben = x_diben(:,6);
global Ts_diben;
Ts_avg_diben = mean(Ts_diben);

%% Print averages
disp("Average Sample Periods");
fprintf('Corollary 2: %f\n\n;', Ts_avg_corr2);
fprintf('Dibenedetto: %f\n\n', Ts_avg_diben);
fprintf('EventTriggered: %f\n\n', Ts_avg_ev);

%% Plot the results
% Figure Parameters
width       = 500;
height      = 200;
font_size   = 25;
marker_size = 9;
line_width  = 1.5;

% Individual plots

%% Corollary 2
% Corollary 2 V plot
color  = 'b';
marker = '*'; 
[modF, modJ] = get_hybrid_plot_mods(color, line_width, marker, marker_size);

figure(1);
plotHarc(t_corr2,j_corr2,V_corr2, [], modF, modJ);
xlabel("Time(s)");
ylabel("V(x)");
set_figure_options(width, height, font_size);

% Corollary 2 Ts plot
figure_number = 2;
plot_Ts(figure_number, color, line_width, marker, marker_size);

global T_corr2; global Ts_corr2;
T_corr2 = T_corr2 - T_corr2(1);
figure(2);
stairs(T_corr2, Ts_corr2, color);
hold on;
scatter(T_corr2, Ts_corr2, color, marker);
xlabel("Time(s)");
ylabel("Sample Period (s)");


%% DiBenedetto
% DiBenedetto V plot
color  = 'm';
marker = 'd'; 
[modF, modJ] = get_hybrid_plot_mods(color, line_width, marker, marker_size);

figure(2);
plotHarc(t_diben,j_diben,V_diben, [], modF, modJ);
xlabel("Time(s)");
ylabel("V(x)");
set_figure_options(width, height, font_size);

%% Event Triggered
% Event Triggered V plot
color  = 'k';
marker = 'o'; 
[modF, modJ] = get_hybrid_plot_mods(color, line_width, marker, marker_size);

figure(3);
plotHarc(t_ev,j_ev,V_ev, [], modF, modJ);
xlabel("Time(s)");
ylabel("V(x)");
set_figure_options(width, height, font_size);







%%

% Sample period
figure(2);
modF{1} = 'b';

modJ{1} = 'b';
modJ{2} = 'Marker';
modJ{3} = 'd';

T_arr = T_arr - T_arr(1);
stairs(T_arr, Ts_arr, "b");
hold on;
scatter(T_arr, Ts_arr, "b*");
% plotHarc(t,j,x(:,6), [0,j(end)], modF, modJ);
xlabel("Time(s)");
ylabel("Sample Period (s)");
set(gca, 'FontName', 'Times New Roman');
set(gcf,'Position',[2 2 500 200]);
hold on;

